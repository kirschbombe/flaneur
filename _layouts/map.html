<!DOCTYPE html>
<html>

  {% include head.html %}
  
  <body>
  	{% include sidebar.html %}
  	   <script>
  	    window.onload = function(){
  	    reloadhtml();
  	    };
	      window.onhashchange = function() {
	      reloadhtml();
	      };
  	    </script>

    <div id="map"></div>

    <script>
      // set up variables to use during jekyll loop
      var lat, lng, content, marker,
          map = L.map('map' , {scrollWheelZoom: false}).setView([0, 0], 1),
          markers = new L.markerClusterGroup();
      L.tileLayer('{{site.map-tileset}}', {
        "attribution" : '{{site.map-credits}}',
        "minZoom" : {{site.minZoom}},
        "maxZoom" : {{site.maxZoom}},
        "errorTileUrl" : "img/error-tile-image.png",
        "subdomains" : ["a", "b", "c", "d"],
        "detectRetina" : true,
      }).addTo(map);

      // jekyll loop through posts

var overLayers = [];
var icons = [];

{% for image in site.static_files %}
    {% if image.path contains 'assets/leaflet/img' %}
        icons.push('{{ image.path }}');
    {% endif %}
{% endfor %}
var counter = -1;
var groups = {};
items = {};
{% for category in site.categories %}
counter += 1;

{% capture category_name %}{{ category | first }}{% endcapture %} 
groups[counter] = L.featureGroup.subGroup(markers);
var control = L.control.layers(null, null, { collapsed: true, position: 'topleft' });

//var panelLayers = L.Control.PanelLayers(null, null, {compact: true,
//	collapsed: true,
//	position: 'topleft'
//});
//map.addControl(panelLayers);
{% for post in site.categories[category_name] %}
      lat = {{ post.lat }};
      lng = {{ post.lng }};

      content = "<strong>{{ post.title }}</strong><br>{{ post.desc }}";
      var iconurl = "{{site.baseurl}}" + icons[counter]

      var mbox = L.icon({
            iconUrl: iconurl,
            iconSize : [32, 37],
            iconAnchor : [17, 36],
            popupAnchor : [-1, 8]
          });
      var marker = L.marker([lat, lng], {
        icon: mbox,
      }).bindPopup(content, {offset:new L.Point(0,-30)});
      marker.iconURL = iconurl;
    
      marker.addTo(groups[counter])

      filename = "{{post.url}}"
      if (items[filename] == undefined) { 
      items[filename] = [marker];
      } else {
      items[filename].push(marker);
      }
      
      marker.on('click', function(){
        post_url = "{{site.baseurl}}/#{{post.url}}";
        article_url = '{{site.baseurl}}{{post.url}}';
        item_id = "{{post.url}}";
        window.location = (post_url);
        articlerender(article_url, item_id);
      });
      
      {% endfor %}
    map.addLayer(markers);
    var imageurl = '<img class="legend" src="' + iconurl + '">'
    var name = imageurl + ' ' + '{{category_name}}';
    overLayers.push({"name":name, "layer":groups[counter]})
 {% endfor %}
      // end loop through posts

for (i = 0; i < overLayers.length; i++) {
	control.addOverlay(overLayers[i]['layer'], overLayers[i]['name']);
	control.addTo(map);
	overLayers[i]['layer'].addTo(map);
}
control.addTo(map);

function setMapView(marker){
	markers.zoomToShowLayer(marker, function () {
		marker.togglePopup();
	});
}

//map.setView({{site.setView}})
map.fitBounds(markers.getBounds());

</script>
{% include menu.html %}
</body>
</html>
